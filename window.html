<!DOCTYPE html>
<html>
    <head>
        <style>
            body {
                margin: 0;
                background-color: dimgrey;
                height: 100%;
                display: flex;
                flex-direction: column;
            }

            html {
                height: 100%;
            }

            #screen {
                flex: 1;
                overflow: hidden;
            }
        </style>

        <script type="module" crossorigin="anonymous">
            import RFB from './node_modules/@novnc/novnc/core/rfb.js';

            let readQueryVariable = (name, defaultValue) => {
                const re = new RegExp(".*[?&]"+name+"=([^&#]*)"), match = document.location.href.match(re);
                if (match) { return decodeURIComponent(match[1]); }
                return defaultValue;
            }

            const host = readQueryVariable('host', window.location.hostname);
            const port = readQueryVariable('port', window.location.port);
            const password = readQueryVariable('password');
            const path = readQueryVariable('path', 'websockify');
            let rfb;
            let desktopName;
            let url;

            console.log("Connecting");

            // URL
            url = window.location.protocol === "https:" ? "wss" : "ws"
            url += "://"+host;
            if (port) { url += ":"+port; }
            url += "/"+path;

            console.log(url)
            // ws://localhost:8001/k8s/apis/subresources.kubevirt.io/v1/namespaces/default/virtualmachineinstances/windows-installer-bios/vnc

            // RFB
            rfb = new RFB(document.getElementById('screen'), url, { credentials: { password: password } });
            rfb.addEventListener("desktopname", (e) => {
                desktopName = e.detail.name;
                console.log(desktopName)
            });
            rfb.addEventListener("connect", (e) => {
                console.log("Connected to "+desktopName);
            });
            rfb.addEventListener("disconnect", (e) => {
                console.log(e.detail.clean ? "Disconnected" : "Something went wrong, connection is closed");
            });
            rfb.viewOnly = readQueryVariable('view_only', false);
            rfb.scaleViewport = readQueryVariable('scale', false);
            // rfb.addEventListener("credentialsrequired", (e) => {
            //     const password = prompt("Password Required:");
            //     rfb.sendCredentials({ password: password });
            // });
            // rfb.sendCtrlAltDel();
        </script>
    </head>

    <body>
        <div id="screen"></div>
    </body>
</html>
